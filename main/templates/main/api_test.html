<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .api-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .method-get { border-left: 4px solid #28a745; }
        .method-post { border-left: 4px solid #007bff; }
        .method-put { border-left: 4px solid #ffc107; }
        .method-delete { border-left: 4px solid #dc3545; }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        button.get { background-color: #28a745; }
        button.post { background-color: #007bff; }
        button.put { background-color: #ffc107; color: #000; }
        button.delete { background-color: #dc3545; }
        
        .response {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea { height: 100px; resize: vertical; }
        
        h1, h2, h3 { color: #333; }
        .status { font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Django API æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="api-section method-get">
            <h3>ğŸ” GET /api/health/ - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</h3>
            <p>APIã®åŸºæœ¬çš„ãªå‹•ä½œç¢ºèª</p>
            <button class="get" onclick="testAPI('/api/health/', 'GET', null, 'health-response')">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="health-response" class="response"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ” èªè¨¼ API ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testLogin()" class="test-button">ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testAuthStatus()" class="test-button">èªè¨¼çŠ¶æ…‹ç¢ºèª</button>
            <pre id="auth-response" class="response"></pre>
        </div>

        <div class="test-section">
            <h3>ğŸŒ¤ï¸ å¤©æ°— API ãƒ†ã‚¹ãƒˆ</h3>
            <div style="margin-bottom: 15px;">
                <label>ç·¯åº¦: <input type="number" id="test-lat" value="35.6762" step="0.0001" placeholder="ä¾‹: 35.6762"></label>
                <label>çµŒåº¦: <input type="number" id="test-lon" value="139.6503" step="0.0001" placeholder="ä¾‹: 139.6503"></label>
                <button onclick="testWeatherAPI()" class="test-button">å¤©æ°—æƒ…å ±å–å¾—</button>
                <button onclick="getLocationAndTestWeather()" class="test-button">ç¾åœ¨åœ°ã‹ã‚‰å–å¾—</button>
            </div>
            <pre id="weather-response" class="response"></pre>
        </div>

        <div class="test-section">
            <h3>ğŸ“š ä½œå“ API ãƒ†ã‚¹ãƒˆ</h3>
            <p>ä»»æ„ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ</p>
            <input type="text" id="custom-url" placeholder="URL (ä¾‹: /api/health/)" value="/api/health/">
            <select id="custom-method">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
            <textarea id="custom-body" placeholder="ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ (JSONå½¢å¼)"></textarea>
            <label>
                <input type="checkbox" id="custom-auth"> èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å«ã‚ã‚‹
            </label><br>
            <button onclick="testCustomAPI()">ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="custom-response" class="response"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ ä½œå“æ¨è–¦ API ãƒ†ã‚¹ãƒˆ</h3>
            <p>å¤©æ°—ã¨æ™‚é–“ã«åŸºã¥ãé’ç©ºæ–‡åº«ä½œå“æ¨è–¦æ©Ÿèƒ½</p>
            <div style="margin-bottom: 15px;">
                <label>ç·¯åº¦: <input type="number" id="recommend-lat" value="35.6762" step="0.0001" placeholder="ä¾‹: 35.6762"></label>
                <label>çµŒåº¦: <input type="number" id="recommend-lon" value="139.6503" step="0.0001" placeholder="ä¾‹: 139.6503"></label>
                <br><br>
                <label>
                    <input type="radio" name="recommend-type" value="simple" checked> ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆæ¨è–¦ (APIã‚­ãƒ¼ä¸è¦ãƒ»é«˜é€Ÿ)
                </label><br>
                <label>
                    <input type="radio" name="recommend-type" value="ai"> LangChain AIç‰ˆæ¨è–¦ (Google APIã‚­ãƒ¼å¿…è¦ãƒ»é«˜åº¦)
                </label><br><br>
                <button onclick="testRecommendAPI()" class="test-button">ä½œå“æ¨è–¦å–å¾—</button>
                <button onclick="getLocationAndTestRecommend()" class="test-button">ç¾åœ¨åœ°ã‹ã‚‰æ¨è–¦</button>
            </div>
            <pre id="recommend-response" class="response"></pre>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š äººæ°—ä½œå“ API ãƒ†ã‚¹ãƒˆ</h3>
            <p>é’ç©ºæ–‡åº«ã®äººæ°—ä½œå“ä¸€è¦§ã‚’å–å¾—</p>
            <button onclick="testPopularBooksAPI()" class="test-button">äººæ°—ä½œå“å–å¾—</button>
            <pre id="popular-books-response" class="response"></pre>
        </div>
    </div>

    <script>
        let accessToken = null;
        let refreshToken = null;

        async function testAPI(url, method = 'GET', data = null, responseId, useAuth = false) {
            const responseElement = document.getElementById(responseId);
            responseElement.textContent = 'å®Ÿè¡Œä¸­...';
            responseElement.className = 'response';

            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (useAuth && accessToken) {
                options.headers['Authorization'] = `Bearer ${accessToken}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const startTime = Date.now();
                const response = await fetch(url, options);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    result = await response.text();
                }

                const statusClass = response.ok ? 'success' : 'error';
                responseElement.className = `response ${statusClass}`;
                responseElement.textContent = `Status: ${response.status} ${response.statusText} (${responseTime}ms)\n\n${JSON.stringify(result, null, 2)}`;

                return { status: response.status, data: result, ok: response.ok };
            } catch (error) {
                responseElement.className = 'response error';
                responseElement.textContent = `Error: ${error.message}`;
                return { status: 0, data: { error: error.message }, ok: false };
            }
        }

        async function testLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const result = await testAPI('/api/auth/login/', 'POST', { email, password }, 'login-response');

            if (result.ok && result.data.access) {
                accessToken = result.data.access;
                refreshToken = result.data.refresh;
                updateTokenInfo();
            }
        }

        async function testRefresh() {
            if (!refreshToken) {
                const responseElement = document.getElementById('refresh-response');
                responseElement.className = 'response error';
                responseElement.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            const result = await testAPI('/api/auth/refresh/', 'POST', { refresh: refreshToken }, 'refresh-response');

            if (result.ok && result.data.access) {
                accessToken = result.data.access;
                if (result.data.refresh) {
                    refreshToken = result.data.refresh;
                }
                updateTokenInfo();
            }
        }

        async function testVerify() {
            if (!accessToken) {
                const responseElement = document.getElementById('verify-response');
                responseElement.className = 'response error';
                responseElement.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            await testAPI('/api/auth/verify/', 'POST', { token: accessToken }, 'verify-response');
        }

        async function testAuthStatus() {
            await testAPI('/api/auth/status/', 'GET', null, 'status-response', true);
        }

        async function testCustomAPI() {
            const url = document.getElementById('custom-url').value;
            const method = document.getElementById('custom-method').value;
            const bodyText = document.getElementById('custom-body').value;
            const useAuth = document.getElementById('custom-auth').checked;

            let body = null;
            if (bodyText.trim()) {
                try {
                    body = JSON.parse(bodyText);
                } catch (e) {
                    const responseElement = document.getElementById('custom-response');
                    responseElement.className = 'response error';
                    responseElement.textContent = `JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                    return;
                }
            }

            await testAPI(url, method, body, 'custom-response', useAuth);
        }

        function updateTokenInfo() {
            const tokenInfoElement = document.getElementById('token-info');
            if (accessToken || refreshToken) {
                tokenInfoElement.textContent = `Access Token: ${accessToken ? accessToken.substring(0, 50) + '...' : 'ãªã—'}\n\nRefresh Token: ${refreshToken ? refreshToken.substring(0, 50) + '...' : 'ãªã—'}`;
            } else {
                tokenInfoElement.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ãã ã•ã„';
            }
        }

        // å¤©æ°—APIãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testWeatherAPI() {
            const lat = document.getElementById('test-lat').value;
            const lon = document.getElementById('test-lon').value;
            
            if (!lat || !lon) {
                document.getElementById('weather-response').textContent = 'ã‚¨ãƒ©ãƒ¼: ç·¯åº¦ã¨çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                document.getElementById('weather-response').className = 'response error';
                return;
            }
            
            const url = `/api/weather/?lat=${lat}&lon=${lon}`;
            await testAPI(url, 'GET', null, 'weather-response');
        }
        
        async function getLocationAndTestWeather() {
            const responseElement = document.getElementById('weather-response');
            responseElement.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
            responseElement.className = 'response';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        document.getElementById('test-lat').value = lat;
                        document.getElementById('test-lon').value = lon;
                        
                        responseElement.textContent = `ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ: ç·¯åº¦=${lat}, çµŒåº¦=${lon}\nå¤©æ°—æƒ…å ±ã‚’å–å¾—ä¸­...`;
                        
                        const url = `/api/weather/?lat=${lat}&lon=${lon}`;
                        await testAPI(url, 'GET', null, 'weather-response');
                    },
                    (error) => {
                        responseElement.textContent = `ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                        responseElement.className = 'response error';
                    }
                );
            } else {
                responseElement.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
                responseElement.className = 'response error';
            }
        }

                 // ä½œå“æ¨è–¦APIãƒ†ã‚¹ãƒˆé–¢æ•°
         async function testRecommendAPI() {
             const lat = document.getElementById('recommend-lat').value;
             const lon = document.getElementById('recommend-lon').value;
             const recommendType = document.querySelector('input[name="recommend-type"]:checked').value;

             if (!lat || !lon) {
                 document.getElementById('recommend-response').textContent = 'ã‚¨ãƒ©ãƒ¼: ç·¯åº¦ã¨çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                 document.getElementById('recommend-response').className = 'response error';
                 return;
             }

             const useAI = recommendType === 'ai' ? 'true' : 'false';
             const url = `/api/recommend/?lat=${lat}&lon=${lon}&use_ai=${useAI}`;
             await testAPI(url, 'GET', null, 'recommend-response');
         }

        async function getLocationAndTestRecommend() {
            const responseElement = document.getElementById('recommend-response');
            responseElement.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
            responseElement.className = 'response';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        document.getElementById('recommend-lat').value = lat;
                        document.getElementById('recommend-lon').value = lon;
                        
                        responseElement.textContent = `ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ: ç·¯åº¦=${lat}, çµŒåº¦=${lon}\nä½œå“æ¨è–¦ã‚’å–å¾—ä¸­...`;
                        
                                                 const url = `/api/recommend/?lat=${lat}&lon=${lon}&use_ai=false`; // ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
                        await testAPI(url, 'GET', null, 'recommend-response');
                    },
                    (error) => {
                        responseElement.textContent = `ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                        responseElement.className = 'response error';
                    }
                );
            } else {
                responseElement.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
                responseElement.className = 'response error';
            }
        }

        // äººæ°—ä½œå“APIãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testPopularBooksAPI() {
            const url = `/api/popular-books/`;
            await testAPI(url, 'GET', null, 'popular-books-response');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        window.addEventListener('load', function() {
            testAPI('/api/health/', 'GET', null, 'health-response');
        });
    </script>
</body>
</html> 