<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈùíÁ©∫„Çª„É¨„ÇØ„Éà</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            /* Material Design 3 Color System - Light Mode */
            --md-primary: #6750a4;
            --md-on-primary: #ffffff;
            --md-primary-container: #eaddff;
            --md-on-primary-container: #21005d;
            
            --md-secondary: #625b71;
            --md-on-secondary: #ffffff;
            --md-secondary-container: #e8def8;
            --md-on-secondary-container: #1d192b;
            
            --md-surface: #fffbfe;
            --md-on-surface: #1c1b1f;
            --md-surface-variant: #f4eff4;
            --md-on-surface-variant: #49454f;
            
            --md-outline: #79747e;
            --md-outline-variant: #cab6cf;
            
            --md-error: #ba1a1a;
            --md-on-error: #ffffff;
            
            /* Elevation */
            --md-elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.12), 0px 1px 2px rgba(0, 0, 0, 0.24);
            --md-elevation-2: 0px 3px 6px rgba(0, 0, 0, 0.16), 0px 3px 6px rgba(0, 0, 0, 0.23);
            --md-elevation-3: 0px 6px 12px rgba(0, 0, 0, 0.15), 0px 4px 6px rgba(0, 0, 0, 0.10);
        }

        /* Dark Mode */
        /* Removed dark mode */
        .removed-dark-mode {
            --md-primary: #d0bcff;
            --md-on-primary: #381e72;
            --md-primary-container: #4f378b;
            --md-on-primary-container: #eaddff;
            
            --md-secondary: #ccc2dc;
            --md-on-secondary: #332d41;
            --md-secondary-container: #4a4458;
            --md-on-secondary-container: #e8def8;
            
            --md-surface: #141218;
            --md-on-surface: #e6e0e9;
            --md-surface-variant: #49454f;
            --md-on-surface-variant: #cab6cf;
            
            --md-outline: #938f99;
            --md-outline-variant: #49454f;
            
            --md-error: #ffb4ab;
            --md-on-error: #690005;
            
            /* Dark Mode Elevation */
            --md-elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.30), 0px 1px 2px rgba(0, 0, 0, 0.50);
            --md-elevation-2: 0px 3px 6px rgba(0, 0, 0, 0.40), 0px 3px 6px rgba(0, 0, 0, 0.60);
            --md-elevation-3: 0px 6px 12px rgba(0, 0, 0, 0.50), 0px 4px 6px rgba(0, 0, 0, 0.30);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.6;
            color: var(--md-on-surface);
            background: var(--md-surface);
            font-weight: 400;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        /* Header */
        header {
            background: var(--md-surface);
            border-bottom: 1px solid var(--md-outline-variant);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--md-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .social-icon {
            color: var(--md-on-surface-variant);
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.2s ease;
            background: transparent;
        }
        
        .social-icon:hover {
            color: var(--md-primary);
            background: var(--md-primary-container);
            transform: translateY(-1px);
        }
        

        

        /* Modern Card Design */
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 48px;
            padding: 0 24px;
        }
        
        .feature-card {
            background: var(--md-surface);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--md-elevation-2);
            transition: all 0.3s ease;
            border: 1px solid var(--md-outline-variant);
        }
        
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--md-elevation-3);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 16px;
            display: block;
        }
        
        .feature-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--md-on-surface);
        }
        
        .feature-description {
            color: var(--md-on-surface-variant);
            line-height: 1.6;
        }
        
        /* Weather & Recommendation Section */
        .weather-recommendation-section {
            padding: 24px 0 48px;
            background: var(--md-surface);
        }
        
        .weather-recommendation-card {
            background: var(--md-surface);
            border-radius: 24px;
            box-shadow: var(--md-elevation-2);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
            border: 1px solid var(--md-outline-variant);
        }
        
        /* Primary Button */
        .btn-primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 16px 32px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--md-elevation-2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            transform: translateY(-2px);
            box-shadow: var(--md-elevation-3);
        }
        
        .btn-primary:disabled {
            background: var(--md-outline-variant);
            color: var(--md-on-surface-variant);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Main content */
        main {
            margin-top: 0;
        }
        

        

        
        /* Weather & Recommendation Section */
        .weather-recommendation-section {
            padding: 48px 0;
        }
        
        .weather-recommendation-card {
            background: var(--md-surface);
            border-radius: 24px;
            box-shadow: var(--md-elevation-2);
            padding: 32px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .section-header h2 {
            font-size: 1.75rem;
            font-weight: 500;
            color: var(--md-on-surface);
            margin-bottom: 8px;
        }
        
        /* Weather Compact Display */
        .weather-compact {
            background: var(--md-surface-variant);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 32px;
        }
        
        .weather-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
            height: 200px;
        }
        
        .weather-main-item {
            background: var(--md-surface);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            text-align: center;
            grid-column: 1 / 4;
            grid-row: 1 / 2;
        }
        
        .weather-icon {
            font-size: 2rem;
            margin-bottom: 0;
        }
        
        .weather-location {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-on-surface);
        }
        
        .weather-temp {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-primary);
        }
        
        .weather-desc {
            font-size: 16px;
            color: var(--md-on-surface-variant);
            font-weight: 500;
        }
        
        .weather-detail-item {
            background: var(--md-surface);
            padding: 12px 8px;
            border-radius: 8px;
            color: var(--md-on-surface-variant);
            font-size: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .weather-detail-item .label {
            font-size: 11px;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        
        .weather-detail-item .value {
            font-weight: 600;
            color: var(--md-on-surface);
            font-size: 14px;
        }
        
        /* Recommendation within weather section */
        .recommendation-embedded {
            border-top: 1px solid var(--md-outline-variant);
            padding-top: 24px;
        }
        
        .recommendation-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .recommendation-header h3 {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--md-on-surface);
            margin-bottom: 8px;
        }
        
        .recommendation-header p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Buttons */
        .btn-primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 14px 32px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--md-elevation-1);
        }
        
        .btn-primary:hover {
            box-shadow: var(--md-elevation-2);
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background: var(--md-outline-variant);
            color: var(--md-on-surface-variant);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: var(--md-on-secondary-container);
            color: var(--md-secondary-container);
        }
        
        /* Radio buttons styled as Material chips */
        .chip-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .chip {
            position: relative;
        }
        
        .chip input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .chip label {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-surface-variant);
            color: var(--md-on-surface-variant);
            padding: 12px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--md-outline-variant);
            font-size: 14px;
            font-weight: 500;
        }
        
        .chip input[type="radio"]:checked + label {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            border-color: var(--md-secondary);
        }
        
        /* Footer */
        .footer {
            background: var(--md-surface-variant);
            padding: 32px 0;
            text-align: center;
            border-top: 1px solid var(--md-outline-variant);
        }
        
        .footer p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
        }
        
        /* Status indicator */
        .status-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: var(--md-elevation-2);
            z-index: 1000;
        }
        
        /* Loading and result styles */
        .result-card {
            background: var(--md-primary-container);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            position: relative;
        }

        .result-card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 8px;
            z-index: 2;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: var(--md-surface);
            color: var(--md-on-surface-variant);
            border: 1px solid var(--md-outline-variant);
            cursor: pointer;
        }
        .icon-btn:hover {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        /* Tabs for recommendation history */
        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .tab-btn {
            background: var(--md-surface-variant);
            color: var(--md-on-surface-variant);
            border: 1px solid var(--md-outline-variant);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
        }
        .tab-btn.active {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            border-color: var(--md-secondary);
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Slider nav (mobile) */
        .slider-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 8px 0 12px;
        }
        .slider-btn {
            background: var(--md-surface-variant);
            color: var(--md-on-surface-variant);
            border: 1px solid var(--md-outline-variant);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
        }
        .slider-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--md-outline-variant);
            border-radius: 50%;
            border-top-color: var(--md-primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        

        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0;
                max-width: 100%;
            }
            
            header {
                padding: 8px 12px;
                margin-bottom: 0;
            }
            

            main {
                margin-top: 0;
            }
            
            .weather-recommendation-section {
                padding: 12px 0 16px;
            }
            
            .weather-recommendation-card {
                margin: 0;
                padding: 16px 12px;
                border-radius: 0;
            }
            
            .section-header h3 {
                font-size: 1.2rem;
                margin-bottom: 12px;
            }
            
            .weather-grid {
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 1fr 1fr;
                gap: 8px;
                height: 160px;
            }
            
            .weather-main-item {
                padding: 8px 6px;
            }
            
            .weather-icon {
                font-size: 1.5rem;
                margin-bottom: 0;
            }
            
            .weather-location {
                font-size: 12px;
            }
            
            .weather-temp {
                font-size: 20px;
            }
            
            .weather-desc {
                font-size: 14px;
            }
            
            .weather-detail-item {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            .weather-detail-item .label {
                font-size: 10px;
            }
            
            .weather-detail-item .value {
                font-size: 12px;
            }
            
            .nav-links a {
                display: none;
            }
            
            .social-icon {
                width: 36px;
                height: 36px;
            }
            
            .chip-group {
                flex-direction: column;
                align-items: center;
            }
            
            .recommendation-section {
                padding: 16px 0;
            }
            
            .recommendation-header {
                margin-bottom: 16px;
                padding: 0 12px;
            }
            
            .recommendation-header h2 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .recommendation-header p {
                font-size: 13px;
                margin-bottom: 0;
            }
            
            #recommendationSettings {
                padding: 0 12px;
            }
            
            #getRecommendationBtn {
                padding: 14px 20px;
                font-size: 1rem;
                width: 100%;
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/" class="logo">ÈùíÁ©∫ÊñáÂ∫´„Ç¢„Ç∑„Çπ„Éà(‰ªÆ)</a>
            <a href="https://x.com/" class="social-icon" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
            </a>
        </div>
    </header>

    <main>


        <!-- Â§©Ê∞óÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <section class="weather-recommendation-section">
            <div class="container">
                <div id="weatherContainer" class="weather-recommendation-card">
                    <div id="weatherLoading" style="display: none;">
                        <h3>üìç ÁèæÂú®Âú∞„ÅÆÂ§©Ê∞ó„ÇíÂèñÂæó‰∏≠...</h3>
                        <p>„Å®„Çä„ÅÇ„Åà„Åö„ÄÅÁü≠„ÅÑÂ∞èË™¨„Åã„ÇâË™≠„Çì„Åß„Åø„Çà„ÅÜ</p>
                    </div>
                    
                    <div id="weatherContent" style="display: none;">
                        <div class="section-header">
                            <h3>ÁèæÂú®„ÅÆÂ§©Ê∞ó</h3>
                        </div>
                        <div class="weather-compact">
                            <div class="weather-grid">
                                <div class="weather-main-item">
                                    <div class="weather-icon" id="weatherEmoji">üå§Ô∏è</div>
                                    <div class="weather-location" id="weatherLocation">ÁèæÂú®Âú∞</div>
                                    <div class="weather-temp" id="weatherTemp">--¬∞C</div>
                                </div>
                                <div class="weather-detail-item">
                                    <div class="label">Â§©Ê∞ó</div>
                                    <div class="value" id="weatherDesc">--</div>
                                </div>
                                <div class="weather-detail-item">
                                    <div class="label">‰ΩìÊÑüÊ∏©Â∫¶</div>
                                    <div class="value" id="weatherFeelsLike">--¬∞C</div>
                                </div>
                                <div class="weather-detail-item">
                                    <div class="label">ÊπøÂ∫¶</div>
                                    <div class="value" id="weatherHumidity">--%</div>
                                </div>
                            </div>
                        </div>

                        <div class="recommendation-embedded">
                            <div class="recommendation-header">
                                <h3>‰ªäÊó•„ÅÆ„Åä„Åô„Åô„ÇÅ</h3>
                                <p>‰ªäÊó•„ÅÆ„Åä„Åô„Åô„ÇÅ„ÇíÈùíÁ©∫ÊñáÂ∫´„ÅÆÁü≠Á∑®„ÇíAI„Åå„Çª„É¨„ÇØ„Éà„Åô„Çã„Çà</p>
                            </div>
                            
                            <!-- Êé®Ëñ¶Ë®≠ÂÆö -->
                            <div id="recommendationSettings">
                                <div style="text-align: center;">
                                    <button class="btn-primary" id="getRecommendationBtn" onclick="handleRecommendationRequest()">
                                        <i class="bi bi-book"></i> <span id="mainButtonText">„Åä„Åô„Åô„ÇÅ„ÅÆÊú¨„ÇíÊé¢„Åô</span>
                                    </button>
                                    <div style="margin-top: 16px; font-size: 14px; color: var(--md-on-surface-variant);">
                                    </div>
                                </div>
                            </div>

                            <!-- Êé®Ëñ¶ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
                            <div id="recommendationResults" style="display: none;">
                                <!-- Â±•Ê≠¥„Çø„Éñ„Éò„ÉÉ„ÉÄ -->
                                <div id="recommendationTabs" class="tabs" style="display:none;"></div>
                                <!-- „Çπ„Éû„ÉõÁî®„Çπ„É©„Ç§„ÉÄ„ÉºÊìç‰Ωú -->
                                <div id="recommendationSliderNav" class="slider-nav" style="display:none;">
                                    <button class="slider-btn" id="slidePrev" onclick="prevRecommendation()"><i class="bi bi-chevron-left"></i></button>
                                    <button class="slider-btn" id="slideNext" onclick="nextRecommendation()"><i class="bi bi-chevron-right"></i></button>
                                </div>
                                <!-- Â±•Ê≠¥„Çø„ÉñÂÜÖÂÆπ -->
                                <div id="recommendationTabPanes"></div>
                                <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
                                <div id="recommendationLoading" class="result-card" style="
                                    text-align: center; 
                                    padding: 40px; 
                                    display: none;
                                ">
                                    <div class="loading-spinner" style="margin-bottom: 16px;"></div>
                                    <h3 style="margin-bottom: 10px; color: var(--md-on-surface);">‰ΩúÂìÅ„ÇíÈÅ∏Êõ∏‰∏≠...</h3>
                                    <p style="color: var(--md-on-surface-variant);">„Å®„Çä„ÅÇ„Åà„Åö„ÄÅÁü≠„ÅÑÂ∞èË™¨„Åã„ÇâË™≠„Çì„Åß„Åø„Çà„ÅÜ</p>
                                </div>

                                <!-- Êé®Ëñ¶ÁµêÊûú -->
                                <div id="recommendationContent" style="display: none;">
                                    <!-- AIÁâàÁµêÊûú -->
                                    <div id="aiRecommendationResult">
                                        <div class="result-card">
                            <div class="result-card-actions">
                                <button class="icon-btn" title="È´òË©ï‰æ°(Like)" onclick="event.stopPropagation();"><span>üëç</span></button>
                                <button class="icon-btn" title="‰ΩéË©ï‰æ°(Dislike)" onclick="event.stopPropagation();"><span>üëé</span></button>
                                <button class="icon-btn" title="ÂÖ±Êúâ(Share)" onclick="event.stopPropagation();"><span>üîó</span></button>
                            </div>
                                            <div style="text-align: center; margin-bottom: 20px;">
                                                <h3 style="font-size: 1.5rem; margin-bottom: 10px;">AIÊé®Ëñ¶‰ΩúÂìÅ</h3>
                                                <div id="aiModelInfo" style="
                                                    font-size: 0.9rem; 
                                                    opacity: 0.8; 
                                                    margin-bottom: 10px;
                                                    color: var(--md-primary);
                                                "></div>
                                            </div>
                                            <div id="aiRecommendationText" style="
                                                font-size: 1.05rem; 
                                                line-height: 1.8; 
                                                white-space: pre-line;
                                                background: rgba(255,255,255,0.05);
                                                padding: 25px;
                                                border-radius: 15px;
                                                border-left: 4px solid rgba(255,255,255,0.3);
                                            "></div>
                                        </div>
                                    </div>


                                </div>

                                <!-- „Ç®„É©„ÉºË°®Á§∫ -->
                                <div id="recommendationError" style="display: none;">
                                    <div class="result-card">
                                        <div style="
                                            background: rgba(255,107,107,0.2); 
                                            border: 2px solid rgba(255,107,107,0.4);
                                            border-radius: 15px; 
                                            padding: 25px; 
                                            text-align: center;
                                        ">
                                            <div style="font-size: 2rem; margin-bottom: 15px;">üòî</div>
                                            <h3 style="margin-bottom: 10px;">Êé®Ëñ¶ÂèñÂæó„Ç®„É©„Éº</h3>
                                            <p id="recommendationErrorMessage" style="opacity: 0.9; margin-bottom: 15px;"></p>
                                    <button class="btn-secondary" onclick="getBookRecommendation()">
                                                <i class="bi bi-arrow-clockwise"></i> ÂÜçË©¶Ë°å
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="weatherError" style="display: none;">
                        <div class="result-card">
                            <h3>üå§Ô∏è Â§©Ê∞óÊÉÖÂ†±</h3>
                            <p>‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åå„ÄÅÁ¥†Êïµ„Å™Ë™≠Êõ∏ÊôÇÈñì„Çí„ÅäÈÅé„Åî„Åó„Åè„Å†„Åï„ÅÑ</p>
                            {% if weather_data %}
                            <div style="margin-top: 20px;">
                                <div style="font-size: 2rem;">{{ weather_emoji }}</div>
                                <div style="font-size: 1.5rem; margin: 10px 0;">{{ weather_data.city_name }} {{ weather_data.temperature }}¬∞C</div>
                                <div>{{ weather_data.weather_description }}</div>
                            </div>
                            {% endif %}
                             <div style="margin-top: 16px; text-align: center;">
                                 <button class="btn-secondary" onclick="retryWeather()"><i class="bi bi-arrow-clockwise"></i> ÂÜçË©¶Ë°å</button>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 ÈùíÁ©∫„Çª„É¨„ÇØ„Éà - Powered by Django & ÈùíÁ©∫ÊñáÂ∫´</p>
        </div>
    </footer>

    <div class="status-indicator" id="apiStatus">
        üîå APIÊé•Á∂öÁ¢∫Ë™ç‰∏≠...
    </div>

    <script>
        // API „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/health/');
                const data = await response.json();
                
                const statusEl = document.getElementById('apiStatus');
                if (statusEl) {
                    if (data.status === 'ok') {
                        statusEl.innerHTML = '‚úÖ API Ê≠£Â∏∏Á®ºÂÉç‰∏≠';
                        statusEl.style.background = '#6750a4';
                    } else {
                        statusEl.innerHTML = '‚ö†Ô∏è API Êé•Á∂ö‰∏çÂÆâÂÆö';
                        statusEl.style.background = '#ed8936';
                    }
                }
                console.log('‚úÖ APIÊé•Á∂öÊ≠£Â∏∏:', data);
            } catch (error) {
                const statusEl = document.getElementById('apiStatus');
                if (statusEl) {
                    statusEl.innerHTML = '‚ùå API Êé•Á∂ö„Ç®„É©„Éº';
                    statusEl.style.background = '#e53e3e';
                }
                console.error('‚ùå APIÊé•Á∂ö„Ç®„É©„Éº:', error);
            }
        }

        // Â§©Ê∞óÊÉÖÂ†±„ÅÆÂèñÂæó„Å®Ë°®Á§∫
        async function loadWeatherData() {
            console.log('üå§Ô∏è Â§©Ê∞óÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„ÇíÈñãÂßã...');
            
            const weatherLoading = document.getElementById('weatherLoading');
            const weatherContent = document.getElementById('weatherContent');
            const weatherError = document.getElementById('weatherError');
            
            // Ë¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
            if (!weatherLoading || !weatherContent) {
                console.warn('‚ö†Ô∏è Â§©Ê∞óÈñ¢ÈÄ£„ÅÆË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            weatherLoading.style.display = 'block';
            
            // ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„ÇíË©¶Ë°å
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // ÊàêÂäüÊôÇ
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        console.log(`üìç ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊàêÂäü: Á∑ØÂ∫¶ ${lat}, ÁµåÂ∫¶ ${lon}`);
                        
                        try {
                            const weatherUrl = `/api/weather/?lat=${lat}&lon=${lon}`;
                            const response = await fetch(weatherUrl);
                            const data = await response.json();
                            
                            if (data.success && data.weather) {
                                updateWeatherUI(data.weather);
                                weatherLoading.style.display = 'none';
                                weatherContent.style.display = 'block';
                            } else {
                                showWeatherError();
                            }
                        } catch (error) {
                            console.error('‚ùå Â§©Ê∞ó„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                            showWeatherError();
                        }
                    },
                    // „Ç®„É©„ÉºÊôÇ
                    (error) => {
                        console.error('‚ùå ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', error.code, error.message);
                        showWeatherError();
                    },
                    // „Ç™„Éó„Ç∑„Éß„É≥
                    {
                        timeout: 10000,
                        enableHighAccuracy: false
                    }
                );
            } else {
                console.error('‚ùå „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                showWeatherError();
            }
        }
        
        function updateWeatherUI(weather) {
            // ÁèæÂú®„ÅÆÊó•‰ªò„ÇíÂèñÂæó
            const now = new Date();
            
            // Â§©Ê∞óÊÉÖÂ†±„ÇíUI„Å´ÂèçÊò†ÔºàÂÆâÂÖ®„Å´Ôºâ
            const weatherElements = {
                'weatherEmoji': weather.emoji || 'üå§Ô∏è',
                'weatherLocation': weather.city_name || 'ÁèæÂú®Âú∞',
                'weatherTemp': `${weather.temperature}¬∞C`,
                'weatherDesc': weather.weather_description || '--',
                'weatherFeelsLike': `${weather.feels_like}¬∞C`,
                'weatherHumidity': `${weather.humidity}%`
            };
            
            Object.entries(weatherElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`‚ö†Ô∏è Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${id}`);
                }
            });
            
            // Êó•‰ªò„Å®ÂõõÂ≠£„ÇíË°®Á§∫Ôºà„Åì„Çå„Çâ„ÅÆË¶ÅÁ¥†„ÅØÂâäÈô§„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÔºâ
            // document.getElementById('weatherDate').textContent = formatDate(now);
            // document.getElementById('weatherSeason').textContent = getSeason(now);
            
            // Êé®Ëñ¶„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊõ¥Êñ∞Ôºà„Åì„ÅÆË¶ÅÁ¥†„ÅØÂâäÈô§„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÔºâ
            // if (weather.recommendation) {
            //     document.getElementById('weatherRecommendation').textContent = weather.recommendation;
            // }
        }
        
        function showWeatherError() {
            const weatherLoading = document.getElementById('weatherLoading');
            const weatherContent = document.getElementById('weatherContent');
            const weatherError = document.getElementById('weatherError');
            
            if (weatherLoading) weatherLoading.style.display = 'none';
            if (weatherContent) weatherContent.style.display = 'none';
            if (weatherError) weatherError.style.display = 'block';
        }

        // ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂÜçË©¶Ë°å
        function retryWeather() {
            const weatherLoading = document.getElementById('weatherLoading');
            const weatherContent = document.getElementById('weatherContent');
            const weatherError = document.getElementById('weatherError');
            
            if (weatherError) weatherError.style.display = 'none';
            if (weatherContent) weatherContent.style.display = 'none';
            if (weatherLoading) weatherLoading.style.display = 'block';
            
            // ÂÜçË©¶Ë°å
            loadWeatherData();
        }





        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÆüË°å
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÄÅÂàùÊúüÂåñÈñãÂßã');
            
            // Ë¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
            const mainButton = document.getElementById('getRecommendationBtn');
            const mainButtonText = document.getElementById('mainButtonText');
            console.log('üîç Ë¶ÅÁ¥†Á¢∫Ë™ç:', { mainButton, mainButtonText });
            
            // „É°„Ç§„É≥„Éú„Çø„É≥„Å´Èï∑Êäº„Åó„Åß„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ„ÇíËøΩÂä†
            setupMainButtonLongPress();
            
            // „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂàùÊúüÁä∂ÊÖã„Å´Ë®≠ÂÆö
            updateMainButtonText();
            
            // „Åù„ÅÆ‰ªñ„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ
            checkAPIStatus();
            loadWeatherData();
            setInterval(checkAPIStatus, 30000);
        });
        
        // „É°„Ç§„É≥„Éú„Çø„É≥„ÅÆÈï∑Êäº„Åó„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ
        function setupMainButtonLongPress() {
            const btn = document.getElementById('getRecommendationBtn');
            if (!btn) return;
            
            let pressTimer;
            
            btn.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    if (excludedRecommendations.length > 0) {
                        if (confirm('Èô§Â§ñÂ±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                            resetExclusionHistory();
                        }
                    }
                }, 1000); // 1ÁßíÈï∑Êäº„Åó
            });
            
            btn.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });
            
            btn.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
            });
            
            // „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂØæÂøú
            btn.addEventListener('touchstart', () => {
                pressTimer = setTimeout(() => {
                    if (excludedRecommendations.length > 0) {
                        if (confirm('Èô§Â§ñÂ±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                            resetExclusionHistory();
                        }
                    }
                }, 1000);
            });
            
            btn.addEventListener('touchend', () => {
                clearTimeout(pressTimer);
            });
        }

        // ‰ΩúÂìÅÊé®Ëñ¶Ê©üËÉΩ
        let currentLocation = null;
        let lastRecommendation = null; // Áõ¥Ââç„ÅÆÊé®Ëñ¶‰ΩúÂìÅ„ÇíË®òÈå≤
        let excludedRecommendations = []; // Èô§Â§ñ„Åô„Çã‰ΩúÂìÅ„ÅÆ„É™„Çπ„Éà
        let recommendationHistory = []; // Â±•Ê≠¥: { id, timestamp, text, model }

        // Áµ±ÂêàÊé®Ëñ¶„Ç∑„Çπ„ÉÜ„É†Áî®„ÅÆÈñ¢Êï∞ÔºàÊé®Ëñ¶„É¢„Éº„ÉâÈÅ∏Êäû„ÅØÂâäÈô§Ôºâ

        // Áµ±ÂêàÊé®Ëñ¶„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        async function getBookRecommendation(isExcludingPrevious = false) {
            console.log('üåü Áµ±ÂêàÊé®Ëñ¶Ê©üËÉΩÈñãÂßã');
            
            // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñÔºàÂÆâÂÖ®„Å´Ôºâ
            const btn = document.getElementById('getRecommendationBtn');
            if (!btn) {
                console.error('‚ùå Êé®Ëñ¶„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'üîç Êé®Ëñ¶‰∏≠...';

            // Áõ¥Ââç„ÅÆÁµêÊûú„ÇíÂ±•Ê≠¥„Å´ÈÄÄÈÅø
            archiveLastRecommendation();

            // UIÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            hideAllRecommendationSections();
            const recommendationResults = document.getElementById('recommendationResults');
            const recommendationLoading = document.getElementById('recommendationLoading');
            
            if (recommendationResults) recommendationResults.style.display = 'block';
            if (recommendationLoading) recommendationLoading.style.display = 'block';

            try {
                // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæóÔºàÊó¢Â≠ò„ÅÆ„ÇÇ„ÅÆ„Åå„ÅÇ„Çå„Å∞‰ΩøÁî®Ôºâ
                if (!currentLocation) {
                    currentLocation = await getCurrentLocation();
                }
                
                // Áµ±ÂêàÊé®Ëñ¶API„ÇíÂëº„Å≥Âá∫„ÅóÔºàÈô§Â§ñ„É™„Çπ„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÇØ„Ç®„É™„Éë„É©„É°„Éº„Çø„Å´ËøΩÂä†Ôºâ
                let url = `/api/integrated-recommend/?lat=${currentLocation.lat}&lon=${currentLocation.lon}`;
                if (excludedRecommendations.length > 0) {
                    // ÈÖçÂàó„ÇíÊñáÂ≠óÂàó„Å´Â§âÊèõ„Åó„Å¶URL„Ç®„É≥„Ç≥„Éº„Éâ
                    const excludeList = excludedRecommendations.join('„ÄÅ');
                    url += `&exclude=${encodeURIComponent(excludeList)}`;
                    console.log(`üö´ Èô§Â§ñ„É™„Çπ„Éà(${excludedRecommendations.length}‰ª∂): ${excludeList}`);
                }
                console.log(`üì° Áµ±ÂêàÊé®Ëñ¶APIÂëº„Å≥Âá∫„Åó: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('üìä Áµ±ÂêàÊé®Ëñ¶ÁµêÊûú:', data);
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíÈö†„Åô
                document.getElementById('recommendationLoading').style.display = 'none';
                
                if (data.success) {
                    showRecommendationResult(data, true);
                    // ÊúÄÊñ∞ÁµêÊûú„Çí lastRecommendation „Å´‰øùÂ≠òÊ∏à„Åø„Å™„ÅÆ„Åß„ÄÅÂ±•Ê≠¥„Çø„Éñ„ÇíÊõ¥Êñ∞
                    renderRecommendationHistoryTabs();
                } else {
                    showRecommendationError(data.message || 'Êé®Ëñ¶„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
            } catch (error) {
                console.error('‚ùå Áµ±ÂêàÊé®Ëñ¶ÂèñÂæó„Ç®„É©„Éº:', error);
                const recommendationLoading = document.getElementById('recommendationLoading');
                if (recommendationLoading) {
                    recommendationLoading.style.display = 'none';
                }
                showRecommendationError('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } finally {
                // „Éú„Çø„É≥„ÇíÂæ©ÂÖÉÔºàÂÆâÂÖ®„Å´Ôºâ
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }

        // Áõ¥Ââç„ÅÆÁµêÊûú„ÇíÂ±•Ê≠¥„Å´‰øùÂ≠òÔºàÈáçË§á„Çø„Ç§„Éà„É´„ÅØËøΩÂä†„Åó„Å™„ÅÑÔºâ
        function archiveLastRecommendation() {
            try {
                const aiRecommendationText = document.getElementById('aiRecommendationText');
                if (!aiRecommendationText) return;
                const text = aiRecommendationText.innerText || aiRecommendationText.textContent || '';
                if (!text || !text.trim()) return;
                const title = extractBookTitle(text) || (text.split('\n')[0] || '').slice(0, 20) || '‰ΩúÂìÅ';

                // Áõ¥Ââç„ÅåÂêå„Åò„Çø„Ç§„Éà„É´„Åæ„Åü„ÅØÂêå„ÅòÊú¨Êñá„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó
                if (recommendationHistory.length > 0) {
                    const head = recommendationHistory[0];
                    if ((head.title && head.title === title) || (head.text && head.text === text)) {
                        renderRecommendationHistoryTabs();
                        return;
                    }
                }

                const id = Date.now().toString();
                recommendationHistory.unshift({ id, title, text, model: 'Áµ±ÂêàAIÊé®Ëñ¶' });
                // „Çø„Ç§„Éà„É´ÈáçË§á„ÇíÈô§ÂéªÔºàÂÖàÈ†≠ÂÑ™ÂÖàÔºâ
                const seen = new Set();
                recommendationHistory = recommendationHistory.filter(item => {
                    const key = item.title || item.text;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                }).slice(0, 5);
                renderRecommendationHistoryTabs();
            } catch (e) {
                console.warn('Â±•Ê≠¥‰øùÂ≠ò„Å´Â§±Êïó:', e);
            }
        }

        function renderRecommendationHistoryTabs() {
            const tabs = document.getElementById('recommendationTabs');
            const panes = document.getElementById('recommendationTabPanes');
            const sliderNav = document.getElementById('recommendationSliderNav');
            if (!tabs || !panes) return;

            if (recommendationHistory.length === 0) {
                tabs.style.display = 'none';
                tabs.innerHTML = '';
                panes.innerHTML = '';
                if (sliderNav) sliderNav.style.display = 'none';
                return;
            }

            tabs.style.display = 'flex';
            tabs.innerHTML = '';
            panes.innerHTML = '';
            if (sliderNav) sliderNav.style.display = (window.innerWidth <= 768) ? 'flex' : 'none';

            recommendationHistory.forEach((item, index) => {
                const btn = document.createElement('a');
                btn.className = 'tab-btn' + (index === 0 ? ' active' : '');
                const label = (item.title && item.title.trim()) ? item.title.trim() : `‰ΩúÂìÅ${index + 1}`;
                // Ê§úÁ¥¢„É™„É≥„ÇØ„ÇíÁîüÊàê
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(label + ' ÈùíÁ©∫ÊñáÂ∫´')}`;
                btn.href = searchUrl;
                btn.target = '_blank';
                btn.rel = 'noopener noreferrer';
                btn.textContent = label;
                // „Çø„ÉñÂàáÊõø„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅØ‰øÆÈ£æ„Ç≠„Éº„Å™„Åó„ÅÆÈÄöÂ∏∏„ÇØ„É™„ÉÉ„ÇØ„ÅÆ„ÅøÂèçÂøú
                btn.addEventListener('click', (e) => {
                    const isModified = e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0;
                    if (!isModified) {
                        e.preventDefault();
                        activateTab(index);
                        scrollActiveTabIntoView();
                    }
                });
                tabs.appendChild(btn);

                const pane = document.createElement('div');
                pane.className = 'tab-pane' + (index === 0 ? ' active' : '');
                const linked = addAozoraLinks(item.text || '');
                pane.innerHTML = `
                    <div class="result-card">
                        <div class="result-card-actions">
                            <button class="icon-btn" title="È´òË©ï‰æ°(Like)" onclick="event.stopPropagation();"><i class="bi bi-hand-thumbs-up"></i></button>
                            <button class="icon-btn" title="‰ΩéË©ï‰æ°(Dislike)" onclick="event.stopPropagation();"><i class="bi bi-hand-thumbs-down"></i></button>
                            <button class="icon-btn" title="ÂÖ±Êúâ(Share)" onclick="event.stopPropagation();"><i class="bi bi-share"></i></button>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="font-size: 1.5rem; margin-bottom: 10px;">AIÊé®Ëñ¶‰ΩúÂìÅ</h3>
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px; color: var(--md-primary);">${item.model || ''}</div>
                        </div>
                        <div style="font-size: 1.05rem; line-height: 1.8; white-space: pre-line; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border-left: 4px solid rgba(255,255,255,0.3);">${linked}</div>
                    </div>
                `;
                panes.appendChild(pane);
            });
        }

        function prevRecommendation() {
            const tabs = document.querySelectorAll('#recommendationTabs .tab-btn');
            let active = 0;
            tabs.forEach((t, i) => { if (t.classList.contains('active')) active = i; });
            const nextIndex = Math.min(Math.max(active - 1, 0), recommendationHistory.length - 1);
            activateTab(nextIndex);
            scrollActiveTabIntoView();
        }

        function nextRecommendation() {
            const tabs = document.querySelectorAll('#recommendationTabs .tab-btn');
            let active = 0;
            tabs.forEach((t, i) => { if (t.classList.contains('active')) active = i; });
            const nextIndex = Math.min(active + 1, recommendationHistory.length - 1);
            activateTab(nextIndex);
            scrollActiveTabIntoView();
        }

        function scrollActiveTabIntoView() {
            const tabsContainer = document.getElementById('recommendationTabs');
            const activeBtn = document.querySelector('#recommendationTabs .tab-btn.active');
            if (tabsContainer && activeBtn) {
                const containerRect = tabsContainer.getBoundingClientRect();
                const btnRect = activeBtn.getBoundingClientRect();
                if (btnRect.left < containerRect.left || btnRect.right > containerRect.right) {
                    activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }
        }

        function activateTab(activeIndex) {
            const tabs = document.querySelectorAll('#recommendationTabs .tab-btn');
            const panes = document.querySelectorAll('#recommendationTabPanes .tab-pane');
            tabs.forEach((t, i) => t.classList.toggle('active', i === activeIndex));
            panes.forEach((p, i) => p.classList.toggle('active', i === activeIndex));
        }

        function escapeHtml(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ÁèæÂú®‰ΩçÁΩÆ„ÇíÂèñÂæó
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const location = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            console.log('üìç ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊàêÂäü:', location);
                            updateLocationStatus(`üìç ÁèæÂú®Âú∞: Á∑ØÂ∫¶ ${location.lat.toFixed(4)}, ÁµåÂ∫¶ ${location.lon.toFixed(4)}`);
                            resolve(location);
                        },
                        (error) => {
                            console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó„ÄÅÊù±‰∫¨ÈßÖ„Çí‰ΩøÁî®:', error);
                            const defaultLocation = { lat: 35.681236, lon: 139.767125 };
                            updateLocationStatus('üìç „Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆÔºàÊù±‰∫¨ÈßÖÔºâ„Çí‰ΩøÁî®‰∏≠');
                            resolve(defaultLocation);
                        },
                        {
                            timeout: 10000,
                            enableHighAccuracy: false
                        }
                    );
                } else {
                    console.warn('‚ö†Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±ÈùûÂØæÂøú„ÄÅÊù±‰∫¨ÈßÖ„Çí‰ΩøÁî®');
                    const defaultLocation = { lat: 35.681236, lon: 139.767125 };
                    updateLocationStatus('üìç „Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆÔºàÊù±‰∫¨ÈßÖÔºâ„Çí‰ΩøÁî®‰∏≠');
                    resolve(defaultLocation);
                }
            });
        }

        // ‰ΩçÁΩÆÊÉÖÂ†±„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
        function updateLocationStatus(message) {
            const locationStatus = document.getElementById('locationStatus');
            if (locationStatus) {
                locationStatus.textContent = message;
            } else {
                console.log('üìç ‰ΩçÁΩÆÊÉÖÂ†±:', message);
            }
        }

        // Áµ±ÂêàÊé®Ëñ¶„Ç∑„Çπ„ÉÜ„É†„Åß„ÅØÂÄãÂà•„ÅÆÊé®Ëñ¶„É¢„Éº„ÉâÈñ¢Êï∞„ÅØ‰∏çË¶Å

        // Êé®Ëñ¶ÁµêÊûú„ÇíË°®Á§∫
        function showRecommendationResult(data, isAI) {
            const recommendationContent = document.getElementById('recommendationContent');
            const aiRecommendationText = document.getElementById('aiRecommendationText');
            const modelInfo = document.getElementById('aiModelInfo');

            // Êñ∞ÁùÄÁµêÊûú„ÅØ„Çø„ÉñÂÅ¥„Å´Áµ±Âêà
            if (data.recommendation) {
                // Áõ¥Ââç„ÅÆÊé®Ëñ¶‰ΩúÂìÅ„ÇíË®òÈå≤
                lastRecommendation = data.recommendation;

                // Èô§Â§ñ„É™„Çπ„ÉàÊõ¥Êñ∞
                const bookTitle = extractBookTitle(data.recommendation);
                if (bookTitle && !excludedRecommendations.includes(bookTitle)) {
                    excludedRecommendations.push(bookTitle);
                    setTimeout(() => { updateMainButtonText(); }, 100);
                }

                // ÊúÄÊñ∞ÁµêÊûú„ÇíÂ±•Ê≠¥„ÅÆ0‰ª∂ÁõÆ„Å®„Åó„Å¶ËøΩÂä†Ôºà„Çø„Ç§„Éà„É´ÊäΩÂá∫„ÉªÈáçË§áÊéíÈô§Ôºâ
                const id = Date.now().toString();
                const title = bookTitle || (data.recommendation.split('\n')[0] || '').slice(0, 20) || '‰ΩúÂìÅ';
                if (recommendationHistory.length > 0) {
                    const head = recommendationHistory[0];
                    if ((head.title && head.title === title) || (head.text && head.text === data.recommendation)) {
                        recommendationHistory[0] = { id, title, text: data.recommendation, model: 'Áµ±ÂêàAIÊé®Ëñ¶' };
                    } else {
                        recommendationHistory.unshift({ id, title, text: data.recommendation, model: 'Áµ±ÂêàAIÊé®Ëñ¶' });
                    }
                } else {
                    recommendationHistory.unshift({ id, title, text: data.recommendation, model: 'Áµ±ÂêàAIÊé®Ëñ¶' });
                }
                const seen = new Set();
                recommendationHistory = recommendationHistory.filter(item => {
                    const key = item.title || item.text;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                }).slice(0, 5);

                // „Çø„Éñ„ÇíÂÜçÊèèÁîªÔºà0‰ª∂ÁõÆ=ÊúÄÊñ∞„Çí„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÔºâ
                renderRecommendationHistoryTabs();

                // Áã¨Á´ãË°®Á§∫„ÇíÈö†„Åó„ÄÅ„Çø„ÉñË°®Á§∫„Å´Áµ±‰∏Ä
                if (recommendationContent) recommendationContent.style.display = 'none';
            }

            if (modelInfo) {
                modelInfo.textContent = 'üåü Áµ±ÂêàAIÊé®Ëñ¶ (Â§©Ê∞ó√óRAG√óÂ≠£ÁØÄÊÑü)';
            }
        }
        
        // Êé®Ëñ¶„ÉÜ„Ç≠„Çπ„Éà„Å´ÈùíÁ©∫ÊñáÂ∫´Ê§úÁ¥¢„É™„É≥„ÇØ„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
        function addAozoraLinks(recommendationText) {
            // ‰ΩúÂìÅÂêç„ÅÆ„Éë„Çø„Éº„É≥„ÇíÊ§úÁ¥¢„Åó„Å¶„É™„É≥„ÇØ„Å´Â§âÊèõ
            let linkedText = recommendationText;
            
            // "-‰ΩúÂìÅÂêç-Ôºö[‰ΩúÂìÅÂêç]" „ÅÆÂΩ¢Âºè„ÇíÊ§úÁ¥¢„Åó„Å¶„É™„É≥„ÇØÂåñ
            linkedText = linkedText.replace(
                /-‰ΩúÂìÅÂêç-Ôºö(.+?)(?:\n|-‰ΩúËÄÖÂêç-|$)/g,
                (match, title) => {
                    const cleanTitle = title.trim();
                    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(cleanTitle + ' ÈùíÁ©∫ÊñáÂ∫´')}`;
                    return `-‰ΩúÂìÅÂêç-Ôºö<a href="${searchUrl}" target="_blank" style="color: var(--md-primary); text-decoration: underline; font-weight: 500;">${cleanTitle}</a><br>`;
                }
            );
            
            // "‰ΩúÂìÅÂêçÔºö[‰ΩúÂìÅÂêç]" „ÅÆÂΩ¢Âºè„ÇÇÊ§úÁ¥¢„Åó„Å¶„É™„É≥„ÇØÂåñ
            linkedText = linkedText.replace(
                /‰ΩúÂìÅÂêç[Ôºö:]\s*(.+?)(?:\n|‰ΩúËÄÖ|$)/g,
                (match, title) => {
                    const cleanTitle = title.trim();
                    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(cleanTitle + ' ÈùíÁ©∫ÊñáÂ∫´')}`;
                    return `‰ΩúÂìÅÂêçÔºö<a href="${searchUrl}" target="_blank" style="color: var(--md-primary); text-decoration: underline; font-weight: 500;">${cleanTitle}</a><br>`;
                }
            );
            
            return linkedText;
        }
        
        // Êé®Ëñ¶„ÉÜ„Ç≠„Çπ„Éà„Åã„Çâ‰ΩúÂìÅÂêç„ÇíÊäΩÂá∫„Åô„ÇãÈñ¢Êï∞
        function extractBookTitle(recommendationText) {
            // "-‰ΩúÂìÅÂêç-Ôºö" „ÅÆÂΩ¢Âºè„Åã„Çâ‰ΩúÂìÅÂêç„ÇíÊäΩÂá∫
            const titleMatch = recommendationText.match(/-‰ΩúÂìÅÂêç-Ôºö(.+?)(?:\n|-‰ΩúËÄÖÂêç-|$)/);
            if (titleMatch && titleMatch[1]) {
                return titleMatch[1].trim();
            }
            
            // Âà•„ÅÆÂΩ¢Âºè„ÇÇË©¶Ë°å
            const altMatch = recommendationText.match(/‰ΩúÂìÅÂêç[Ôºö:]\s*(.+?)(?:\n|‰ΩúËÄÖ|$)/);
            if (altMatch && altMatch[1]) {
                return altMatch[1].trim();
            }
            
            // ÊúÄÂæå„ÅÆÊâãÊÆµ„Å®„Åó„Å¶ÊúÄÂàù„ÅÆË°å„Åã„ÇâÊé®Ê∏¨
            const lines = recommendationText.split('\n');
            for (const line of lines) {
                if (line.includes('‰ΩúÂìÅ') && line.includes('Ôºö')) {
                    const parts = line.split('Ôºö');
                    if (parts.length > 1) {
                        return parts[1].trim();
                    }
                }
            }
            
            return null;
        }

        // Êé®Ëñ¶„Ç®„É©„Éº„ÇíË°®Á§∫
        function showRecommendationError(message) {
            const recommendationError = document.getElementById('recommendationError');
            const recommendationErrorMessage = document.getElementById('recommendationErrorMessage');
            
            if (recommendationError) {
                recommendationError.style.display = 'block';
            }
            
            if (recommendationErrorMessage) {
                recommendationErrorMessage.textContent = message;
            }
        }

        // Êé®Ëñ¶„Çª„ÇØ„Ç∑„Éß„É≥„Çí„Åô„Åπ„Å¶Èö†„Åô
        function hideAllRecommendationSections() {
            const elements = [
                'recommendationLoading',
                'recommendationContent', 
                'recommendationError'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
        }

        // ‰ªñ„ÅÆ‰ΩúÂìÅ„ÇíÊé¢„ÅôÊ©üËÉΩ
        async function findOtherBook() {
            console.log(`üîç ‰ªñ„ÅÆ‰ΩúÂìÅ„ÇíÊé¢„Åô (Èô§Â§ñÊï∞: ${excludedRecommendations.length})`);
            
            // Èô§Â§ñ„É™„Çπ„Éà„Çí‰Ωø„Å£„Å¶Êñ∞„Åó„ÅÑÊé®Ëñ¶„ÇíÂèñÂæó
            await getBookRecommendation(true);
        }
        
        // Èô§Â§ñÂ±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà„Åô„ÇãÊ©üËÉΩ
        function resetExclusionHistory() {
            const excludedCount = excludedRecommendations.length;
            excludedRecommendations = [];
            lastRecommendation = null;
            updateMainButtonText();
            console.log(`üîÑ Èô§Â§ñÂ±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà (${excludedCount}‰ª∂„Çí„ÇØ„É™„Ç¢)`);
        }
        
        // „É°„Ç§„É≥„Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞
        function updateMainButtonText() {
            const mainButtonText = document.getElementById('mainButtonText');
            const mainButton = document.getElementById('getRecommendationBtn');
            
            console.log('üîß „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞:', {
                element: mainButtonText,
                buttonElement: mainButton,
                excludedCount: excludedRecommendations.length,
                excludedList: excludedRecommendations
            });
            
            const newText = excludedRecommendations.length > 0 ? '‰ªñ„ÅÆ‰ΩúÂìÅ„ÇíÊé¢„Åô' : '„Åä„Åô„Åô„ÇÅ„ÅÆÊú¨„ÇíÊé¢„Åô';
            
            if (mainButtonText) {
                mainButtonText.textContent = newText;
                console.log(`‚úÖ spanË¶ÅÁ¥†„Åß„Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„Äå${newText}„Äç„Å´Â§âÊõ¥`);
            } else if (mainButton) {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: spanË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÁõ¥Êé•„Éú„Çø„É≥„ÅÆinnerHTML„ÇíÂ§âÊõ¥
                mainButton.innerHTML = `üìö ${newText}`;
                console.log(`üîÑ „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éú„Çø„É≥ÂÖ®‰Ωì„Çí„Äå${newText}„Äç„Å´Â§âÊõ¥`);
            } else {
                console.error('‚ùå mainButtonText„ÇÇgetRecommendationBtn„ÇÇË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                // „Åï„Çâ„Å™„Çã„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Çª„É¨„ÇØ„Çø„Éº„ÅßÊ§úÁ¥¢
                const fallbackButton = document.querySelector('.btn-primary');
                if (fallbackButton) {
                    fallbackButton.innerHTML = `üìö ${newText}`;
                    console.log(`üÜò „Çª„É¨„ÇØ„Çø„Éº„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éú„Çø„É≥„Çí„Äå${newText}„Äç„Å´Â§âÊõ¥`);
                }
            }
        }
        
        // Áµ±Âêà„Åï„Çå„ÅüÊé®Ëñ¶„É™„ÇØ„Ç®„Çπ„ÉàÂá¶ÁêÜ
        function handleRecommendationRequest() {
            if (excludedRecommendations.length > 0) {
                // Èô§Â§ñ„É™„Çπ„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰ªñ„ÅÆ‰ΩúÂìÅ„ÇíÊé¢„Åô
                findOtherBook();
            } else {
                // ÂàùÂõû„Åæ„Åü„ÅØÂ±•Ê≠¥„É™„Çª„ÉÉ„ÉàÂæå„ÅØÈÄöÂ∏∏Êé®Ëñ¶
                getBookRecommendation();
            }
        }

        // Áµ±ÂêàÊé®Ëñ¶„Ç∑„Çπ„ÉÜ„É†„Åß„ÅØÂÄãÂà•„ÅÆRAG„ÉÜ„Çπ„ÉàÈñ¢Êï∞„ÅØ‰∏çË¶Å
        
        // I'm Feeling LuckyÊ©üËÉΩ
        function feelingLucky() {
            // „Åô„Åê„Å´Êé®Ëñ¶„ÇíÂÆüË°å
            getBookRecommendation();
        }

        // CSRF„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


    </script>
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .recommendation-section .text-center {
            text-align: center;
        }
        
        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            #recommendationResults {
                margin: 16px 0;
            }
            
            .result-card {
                padding: 16px 12px;
                margin: 0;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .result-card h3 {
                font-size: 1.3rem;
                margin-bottom: 12px;
            }
            
                    #aiRecommendationText {
            font-size: 1rem !important;
            line-height: 1.6 !important;
            padding: 16px !important;
        }
        
        #aiRecommendationText a {
            color: var(--md-primary) !important;
            text-decoration: underline !important;
            font-weight: 500 !important;
            transition: color 0.2s ease !important;
        }
        
        #aiRecommendationText a:hover {
            color: var(--md-primary-container) !important;
            text-decoration: none !important;
        }
            
            #aiModelInfo {
                font-size: 0.8rem !important;
                margin-bottom: 8px !important;
            }
            
            .loading-spinner {
                width: 20px !important;
                height: 20px !important;
            }
            
            .recommendation-error {
                margin: 16px 0;
                padding: 16px 12px;
                border-radius: 0;
            }
            
            .status-indicator {
                position: fixed;
                bottom: 10px;
                right: 10px;
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            /* „É¢„Éê„Ç§„É´„Åß„ÅØ„Çø„Éñ„ÅØÊ®™„Çπ„ÇØ„É≠„Éº„É´È¢®„ÅÆ„Çπ„É©„Ç§„ÉâUI„Å´ */
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            .tabs .tab-btn {
                display: inline-block;
                white-space: nowrap;
                max-width: 70vw;
                text-overflow: ellipsis;
                overflow: hidden;
            }
            .slider-nav { display: flex !important; }
        }
    </style>
</body>
</html> 