<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青空セレクト</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            /* Material Design 3 Color System - Light Mode */
            --md-primary: #6750a4;
            --md-on-primary: #ffffff;
            --md-primary-container: #eaddff;
            --md-on-primary-container: #21005d;
            
            --md-secondary: #625b71;
            --md-on-secondary: #ffffff;
            --md-secondary-container: #e8def8;
            --md-on-secondary-container: #1d192b;
            
            --md-surface: #fffbfe;
            --md-on-surface: #1c1b1f;
            --md-surface-variant: #f4eff4;
            --md-on-surface-variant: #49454f;
            
            --md-outline: #79747e;
            --md-outline-variant: #cab6cf;
            
            --md-error: #ba1a1a;
            --md-on-error: #ffffff;
            
            /* Elevation */
            --md-elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.12), 0px 1px 2px rgba(0, 0, 0, 0.24);
            --md-elevation-2: 0px 3px 6px rgba(0, 0, 0, 0.16), 0px 3px 6px rgba(0, 0, 0, 0.23);
            --md-elevation-3: 0px 6px 12px rgba(0, 0, 0, 0.15), 0px 4px 6px rgba(0, 0, 0, 0.10);
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --md-primary: #d0bcff;
            --md-on-primary: #381e72;
            --md-primary-container: #4f378b;
            --md-on-primary-container: #eaddff;
            
            --md-secondary: #ccc2dc;
            --md-on-secondary: #332d41;
            --md-secondary-container: #4a4458;
            --md-on-secondary-container: #e8def8;
            
            --md-surface: #141218;
            --md-on-surface: #e6e0e9;
            --md-surface-variant: #49454f;
            --md-on-surface-variant: #cab6cf;
            
            --md-outline: #938f99;
            --md-outline-variant: #49454f;
            
            --md-error: #ffb4ab;
            --md-on-error: #690005;
            
            /* Dark Mode Elevation */
            --md-elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.30), 0px 1px 2px rgba(0, 0, 0, 0.50);
            --md-elevation-2: 0px 3px 6px rgba(0, 0, 0, 0.40), 0px 3px 6px rgba(0, 0, 0, 0.60);
            --md-elevation-3: 0px 6px 12px rgba(0, 0, 0, 0.50), 0px 4px 6px rgba(0, 0, 0, 0.30);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.6;
            color: var(--md-on-surface);
            background: var(--md-surface);
            font-weight: 400;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        /* Header */
        header {
            background: var(--md-surface);
            border-bottom: 1px solid var(--md-outline-variant);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--md-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            background: var(--md-surface-variant);
            color: var(--md-on-surface-variant);
            border: 1px solid var(--md-outline-variant);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
        }
        
        /* Hero Section */
        .hero {
            padding: 80px 0 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(var(--md-primary-rgb), 0.08) 0%, rgba(var(--md-secondary-rgb), 0.05) 100%);
        }
        
        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--md-primary), var(--md-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hero .subtitle {
            font-size: 1.3rem;
            color: var(--md-on-surface-variant);
            margin-bottom: 16px;
            font-weight: 400;
        }
        
        /* Modern Card Design */
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 48px;
            padding: 0 24px;
        }
        
        .feature-card {
            background: var(--md-surface);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--md-elevation-2);
            transition: all 0.3s ease;
            border: 1px solid var(--md-outline-variant);
        }
        
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--md-elevation-3);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 16px;
            display: block;
        }
        
        .feature-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--md-on-surface);
        }
        
        .feature-description {
            color: var(--md-on-surface-variant);
            line-height: 1.6;
        }
        
        /* Weather & Recommendation Section */
        .weather-recommendation-section {
            padding: 48px 0;
            background: var(--md-surface);
        }
        
        .weather-recommendation-card {
            background: var(--md-surface);
            border-radius: 24px;
            box-shadow: var(--md-elevation-2);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
            border: 1px solid var(--md-outline-variant);
        }
        
        /* Primary Button */
        .btn-primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 16px 32px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--md-elevation-2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            transform: translateY(-2px);
            box-shadow: var(--md-elevation-3);
        }
        
        .btn-primary:disabled {
            background: var(--md-outline-variant);
            color: var(--md-on-surface-variant);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Main content */
        main {
            margin-top: 0;
        }
        

        

        
        /* Weather & Recommendation Section */
        .weather-recommendation-section {
            padding: 48px 0;
        }
        
        .weather-recommendation-card {
            background: var(--md-surface);
            border-radius: 24px;
            box-shadow: var(--md-elevation-2);
            padding: 32px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .section-header h2 {
            font-size: 1.75rem;
            font-weight: 500;
            color: var(--md-on-surface);
            margin-bottom: 8px;
        }
        
        /* Weather Compact Display */
        .weather-compact {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 24px;
            align-items: center;
            background: var(--md-surface-variant);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 32px;
        }
        
        .weather-icon {
            font-size: 2.5rem;
        }
        
        .weather-main-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .weather-location {
            font-size: 18px;
            font-weight: 600;
            color: var(--md-on-surface);
        }
        
        .weather-temp {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-primary);
        }
        
        .weather-desc {
            font-size: 14px;
            color: var(--md-on-surface-variant);
        }
        
        .weather-details-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            text-align: right;
            font-size: 12px;
        }
        
        .weather-detail-mini {
            color: var(--md-on-surface-variant);
        }
        
        .weather-detail-mini .value {
            font-weight: 600;
            color: var(--md-on-surface);
        }
        
        /* Recommendation within weather section */
        .recommendation-embedded {
            border-top: 1px solid var(--md-outline-variant);
            padding-top: 24px;
        }
        
        .recommendation-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .recommendation-header h3 {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--md-on-surface);
            margin-bottom: 8px;
        }
        
        .recommendation-header p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Buttons */
        .btn-primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            padding: 14px 32px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--md-elevation-1);
        }
        
        .btn-primary:hover {
            box-shadow: var(--md-elevation-2);
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background: var(--md-outline-variant);
            color: var(--md-on-surface-variant);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: var(--md-on-secondary-container);
            color: var(--md-secondary-container);
        }
        
        /* Radio buttons styled as Material chips */
        .chip-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .chip {
            position: relative;
        }
        
        .chip input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .chip label {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-surface-variant);
            color: var(--md-on-surface-variant);
            padding: 12px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--md-outline-variant);
            font-size: 14px;
            font-weight: 500;
        }
        
        .chip input[type="radio"]:checked + label {
            background: var(--md-secondary-container);
            color: var(--md-on-secondary-container);
            border-color: var(--md-secondary);
        }
        
        /* Footer */
        .footer {
            background: var(--md-surface-variant);
            padding: 32px 0;
            text-align: center;
            border-top: 1px solid var(--md-outline-variant);
        }
        
        .footer p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
        }
        
        /* Status indicator */
        .status-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: var(--md-elevation-2);
            z-index: 1000;
        }
        
        /* Loading and result styles */
        .result-card {
            background: var(--md-primary-container);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--md-outline-variant);
            border-radius: 50%;
            border-top-color: var(--md-primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        

        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .weather-compact {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 16px;
            }
            
            .weather-details-mini {
                grid-template-columns: repeat(4, 1fr);
                text-align: center;
            }
            
            .nav-links a:not(.theme-toggle) {
                display: none;
            }
            
            .chip-group {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/" class="logo">📚 青空セレクト</a>
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="テーマ切り替え">
                <span>🌙</span>
                <span>ダークモード</span>
            </button>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="hero">
            <div class="container">
                <h1>本を読もうにゃ</h1>
                <a class="subtitle" href="https://www.youtube.com/@biwakokun">このクソみたいな日常から脱却するために</a>
            </div>
        </section>

        <!-- 天気情報セクション -->
        <section class="weather-recommendation-section">
            <div class="container">
                <div id="weatherContainer" class="weather-recommendation-card">
                    <div id="weatherLoading" style="display: none;">
                        <h3>📍 現在地の天気を取得中...</h3>
                        <p>とりあえず、短い小説から読んでみよう</p>
                    </div>
                    
                    <div id="weatherContent" style="display: none;">
                        <div class="section-header">
                            <h3>現在の天気</h3>
                        </div>
                        <div class="weather-compact">
                            <div class="weather-icon" id="weatherEmoji">🌤️</div>
                            <div class="weather-main-info">
                                <div class="weather-location" id="weatherLocation">現在地</div>
                                <div class="weather-temp" id="weatherTemp">--°C</div>
                                <div class="weather-desc" id="weatherDesc">--</div>
                            </div>
                            <div class="weather-details-mini">
                                <div class="weather-detail-mini">
                                    <div class="label">体感温度</div>
                                    <div class="value" id="weatherFeelsLike">--°C</div>
                                </div>
                                <div class="weather-detail-mini">
                                    <div class="label">湿度</div>
                                    <div class="value" id="weatherHumidity">--%</div>
                                </div>
                                <div class="weather-detail-mini">
                                    <div class="label">風速</div>
                                    <div class="value" id="weatherWind">-- m/s</div>
                                </div>
                                <div class="weather-detail-mini">
                                    <div class="label">雲量</div>
                                    <div class="value" id="weatherClouds">--%</div>
                                </div>
                            </div>
                        </div>

                        <div class="recommendation-embedded">
                            <div class="recommendation-header">
                                <h3>今日のおすすめ</h3>
                                <p>今日のおすすめを青空文庫の短編をAIがセレクトするよ</p>
                            </div>
                            
                            <!-- 推薦設定 -->
                            <div id="recommendationSettings">
                                <div style="text-align: center;">
                                    <button class="btn-primary" id="getRecommendationBtn" onclick="getBookRecommendation()">
                                        📚 おすすめの本を探す
                                    </button>
                                    <div style="margin-top: 16px; font-size: 14px; color: var(--md-on-surface-variant);">
                                    </div>
                                </div>
                            </div>

                            <!-- 推薦結果表示エリア -->
                            <div id="recommendationResults" style="display: none;">
                                <!-- ローディング -->
                                <div id="recommendationLoading" class="result-card" style="
                                    text-align: center; 
                                    padding: 40px; 
                                    display: none;
                                ">
                                    <div class="loading-spinner" style="margin-bottom: 16px;"></div>
                                    <h3 style="margin-bottom: 10px; color: var(--md-on-surface);">作品を選書中...</h3>
                                    <p style="color: var(--md-on-surface-variant);">天気と時間を考慮して最適な作品を探しています</p>
                                </div>

                                <!-- 推薦結果 -->
                                <div id="recommendationContent" style="display: none;">
                                    <!-- AI版結果 -->
                                    <div id="aiRecommendationResult">
                                        <div class="result-card">
                                            <div style="text-align: center; margin-bottom: 20px;">
                                                <h3 style="font-size: 1.5rem; margin-bottom: 10px;">🤖 AI推薦作品</h3>
                                                <div id="aiModelInfo" style="
                                                    font-size: 0.9rem; 
                                                    opacity: 0.8; 
                                                    margin-bottom: 10px;
                                                    color: var(--md-primary);
                                                "></div>
                                            </div>
                                            <div id="aiRecommendationText" style="
                                                font-size: 1.05rem; 
                                                line-height: 1.8; 
                                                white-space: pre-line;
                                                background: rgba(255,255,255,0.05);
                                                padding: 25px;
                                                border-radius: 15px;
                                                border-left: 4px solid rgba(255,255,255,0.3);
                                            "></div>
                                        </div>
                                    </div>

                                    <!-- 再推薦ボタン -->
                                    <div style="text-align: center; margin-top: 25px;">
                                        <button class="btn-secondary" onclick="getBookRecommendation()">
                                            🔄 別の作品を推薦してもらう
                                        </button>
                                    </div>
                                </div>

                                <!-- エラー表示 -->
                                <div id="recommendationError" style="display: none;">
                                    <div class="result-card">
                                        <div style="
                                            background: rgba(255,107,107,0.2); 
                                            border: 2px solid rgba(255,107,107,0.4);
                                            border-radius: 15px; 
                                            padding: 25px; 
                                            text-align: center;
                                        ">
                                            <div style="font-size: 2rem; margin-bottom: 15px;">😔</div>
                                            <h3 style="margin-bottom: 10px;">推薦取得エラー</h3>
                                            <p id="recommendationErrorMessage" style="opacity: 0.9; margin-bottom: 15px;"></p>
                                            <button class="btn-secondary" onclick="getBookRecommendation()">
                                                🔄 再試行
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="weatherError" style="display: none;">
                        <div class="result-card">
                            <h3>🌤️ 天気情報</h3>
                            <p>位置情報が取得できませんが、素敵な読書時間をお過ごしください</p>
                            {% if weather_data %}
                            <div style="margin-top: 20px;">
                                <div style="font-size: 2rem;">{{ weather_emoji }}</div>
                                <div style="font-size: 1.5rem; margin: 10px 0;">{{ weather_data.city_name }} {{ weather_data.temperature }}°C</div>
                                <div>{{ weather_data.weather_description }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </section>


    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 青空セレクト - Powered by Django & 青空文庫</p>
        </div>
    </footer>

    <div class="status-indicator" id="apiStatus">
        🔌 API接続確認中...
    </div>

    <script>
        // API ヘルスチェック
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/health/');
                const data = await response.json();
                
                const statusEl = document.getElementById('apiStatus');
                if (statusEl) {
                    if (data.status === 'ok') {
                        statusEl.innerHTML = '✅ API 正常稼働中';
                        statusEl.style.background = '#6750a4';
                    } else {
                        statusEl.innerHTML = '⚠️ API 接続不安定';
                        statusEl.style.background = '#ed8936';
                    }
                }
                console.log('✅ API接続正常:', data);
            } catch (error) {
                const statusEl = document.getElementById('apiStatus');
                if (statusEl) {
                    statusEl.innerHTML = '❌ API 接続エラー';
                    statusEl.style.background = '#e53e3e';
                }
                console.error('❌ API接続エラー:', error);
            }
        }

        // 天気情報の取得と表示
        async function loadWeatherData() {
            console.log('🌤️ 天気情報の読み込みを開始...');
            
            const weatherLoading = document.getElementById('weatherLoading');
            const weatherContent = document.getElementById('weatherContent');
            const weatherError = document.getElementById('weatherError');
            
            // 要素の存在確認
            if (!weatherLoading || !weatherContent) {
                console.warn('⚠️ 天気関連の要素が見つかりません');
                return;
            }
            
            // ローディング表示
            weatherLoading.style.display = 'block';
            
            // 位置情報の取得を試行
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // 成功時
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        console.log(`📍 位置情報取得成功: 緯度 ${lat}, 経度 ${lon}`);
                        
                        try {
                            const weatherUrl = `/api/weather/?lat=${lat}&lon=${lon}`;
                            const response = await fetch(weatherUrl);
                            const data = await response.json();
                            
                            if (data.success && data.weather) {
                                updateWeatherUI(data.weather);
                                weatherLoading.style.display = 'none';
                                weatherContent.style.display = 'block';
                            } else {
                                showWeatherError();
                            }
                        } catch (error) {
                            console.error('❌ 天気データ取得エラー:', error);
                            showWeatherError();
                        }
                    },
                    // エラー時
                    (error) => {
                        console.error('❌ 位置情報取得エラー:', error.code, error.message);
                        showWeatherError();
                    },
                    // オプション
                    {
                        timeout: 10000,
                        enableHighAccuracy: false
                    }
                );
            } else {
                console.error('❌ このブラウザは位置情報をサポートしていません');
                showWeatherError();
            }
        }
        
        function updateWeatherUI(weather) {
            // 現在の日付を取得
            const now = new Date();
            
            // 天気情報をUIに反映（安全に）
            const weatherElements = {
                'weatherEmoji': weather.emoji || '🌤️',
                'weatherLocation': weather.city_name || '現在地',
                'weatherTemp': `${weather.temperature}°C`,
                'weatherDesc': weather.weather_description || '--',
                'weatherFeelsLike': `${weather.feels_like}°C`,
                'weatherHumidity': `${weather.humidity}%`,
                'weatherWind': `${weather.wind_speed} m/s`,
                'weatherClouds': `${weather.clouds}%`
            };
            
            Object.entries(weatherElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`⚠️ 要素が見つかりません: ${id}`);
                }
            });
            
            // 日付と四季を表示（これらの要素は削除されているのでコメントアウト）
            // document.getElementById('weatherDate').textContent = formatDate(now);
            // document.getElementById('weatherSeason').textContent = getSeason(now);
            
            // 推薦メッセージを更新（この要素は削除されているのでコメントアウト）
            // if (weather.recommendation) {
            //     document.getElementById('weatherRecommendation').textContent = weather.recommendation;
            // }
        }
        
        function showWeatherError() {
            const weatherLoading = document.getElementById('weatherLoading');
            const weatherContent = document.getElementById('weatherContent');
            const weatherError = document.getElementById('weatherError');
            
            if (weatherLoading) weatherLoading.style.display = 'none';
            if (weatherContent) weatherContent.style.display = 'none';
            if (weatherError) weatherError.style.display = 'block';
        }





        // ページ読み込み時に実行
        window.addEventListener('load', () => {
            // テーマを最初に設定
            setupThemeToggle();
            
            // 統合推薦システムでは特別なリスナー設定は不要
            
            // その他の初期化処理
            checkAPIStatus();
            loadWeatherData();
            setInterval(checkAPIStatus, 30000);
        });

        // 作品推薦機能
        let currentLocation = null;

        // 統合推薦システム用の関数（推薦モード選択は削除）

        // 統合推薦を取得する関数
        async function getBookRecommendation() {
            console.log('🌟 統合推薦機能開始');
            
            // ボタンを無効化（安全に）
            const btn = document.getElementById('getRecommendationBtn');
            if (!btn) {
                console.error('❌ 推薦ボタンが見つかりません');
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '🔍 推薦中...';

            // UI状態をリセット
            hideAllRecommendationSections();
            const recommendationResults = document.getElementById('recommendationResults');
            const recommendationLoading = document.getElementById('recommendationLoading');
            
            if (recommendationResults) recommendationResults.style.display = 'block';
            if (recommendationLoading) recommendationLoading.style.display = 'block';

            try {
                // 位置情報を取得（既存のものがあれば使用）
                if (!currentLocation) {
                    currentLocation = await getCurrentLocation();
                }
                
                // 統合推薦APIを呼び出し
                const url = `/api/integrated-recommend/?lat=${currentLocation.lat}&lon=${currentLocation.lon}`;
                console.log(`📡 統合推薦API呼び出し: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('📊 統合推薦結果:', data);
                
                // ローディングを隠す
                document.getElementById('recommendationLoading').style.display = 'none';
                
                if (data.success) {
                    showRecommendationResult(data, true);
                } else {
                    showRecommendationError(data.message || '推薦の取得に失敗しました');
                }
                
            } catch (error) {
                console.error('❌ 統合推薦取得エラー:', error);
                const recommendationLoading = document.getElementById('recommendationLoading');
                if (recommendationLoading) {
                    recommendationLoading.style.display = 'none';
                }
                showRecommendationError('ネットワークエラーが発生しました。しばらく時間をおいて再試行してください。');
            } finally {
                // ボタンを復元（安全に）
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }

        // 現在位置を取得
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const location = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            console.log('📍 位置情報取得成功:', location);
                            updateLocationStatus(`📍 現在地: 緯度 ${location.lat.toFixed(4)}, 経度 ${location.lon.toFixed(4)}`);
                            resolve(location);
                        },
                        (error) => {
                            console.warn('⚠️ 位置情報取得失敗、東京駅を使用:', error);
                            const defaultLocation = { lat: 35.681236, lon: 139.767125 };
                            updateLocationStatus('📍 デフォルト位置（東京駅）を使用中');
                            resolve(defaultLocation);
                        },
                        {
                            timeout: 10000,
                            enableHighAccuracy: false
                        }
                    );
                } else {
                    console.warn('⚠️ 位置情報非対応、東京駅を使用');
                    const defaultLocation = { lat: 35.681236, lon: 139.767125 };
                    updateLocationStatus('📍 デフォルト位置（東京駅）を使用中');
                    resolve(defaultLocation);
                }
            });
        }

        // 位置情報ステータスを更新
        function updateLocationStatus(message) {
            const locationStatus = document.getElementById('locationStatus');
            if (locationStatus) {
                locationStatus.textContent = message;
            } else {
                console.log('📍 位置情報:', message);
            }
        }

        // 統合推薦システムでは個別の推薦モード関数は不要

        // 推薦結果を表示
        function showRecommendationResult(data, isAI) {
            const recommendationContent = document.getElementById('recommendationContent');
            const aiRecommendationText = document.getElementById('aiRecommendationText');
            const modelInfo = document.getElementById('aiModelInfo');
            
            if (recommendationContent) {
                recommendationContent.style.display = 'block';
            }
            
            if (aiRecommendationText && data.recommendation) {
                aiRecommendationText.textContent = data.recommendation;
            }
            
            if (modelInfo) {
                modelInfo.textContent = '🌟 統合AI推薦 (天気×RAG×季節感)';
            }
        }

        // 推薦エラーを表示
        function showRecommendationError(message) {
            const recommendationError = document.getElementById('recommendationError');
            const recommendationErrorMessage = document.getElementById('recommendationErrorMessage');
            
            if (recommendationError) {
                recommendationError.style.display = 'block';
            }
            
            if (recommendationErrorMessage) {
                recommendationErrorMessage.textContent = message;
            }
        }

        // 推薦セクションをすべて隠す
        function hideAllRecommendationSections() {
            const elements = [
                'recommendationLoading',
                'recommendationContent', 
                'recommendationError'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
        }

        // 統合推薦システムでは個別のRAGテスト関数は不要
        
        // I'm Feeling Lucky機能
        function feelingLucky() {
            // すぐに推薦を実行
            getBookRecommendation();
        }

        // CSRFトークンを取得する関数
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ダークモード切り替え機能
        function toggleTheme() {
            const htmlElement = document.documentElement;
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const themeToggle = document.querySelector('.theme-toggle');
            const iconSpan = themeToggle?.querySelector('span:first-child');
            const textSpan = themeToggle?.querySelector('span:last-child');
            
            if (iconSpan && textSpan) {
                if (document.documentElement.getAttribute('data-theme') === 'dark') {
                    iconSpan.textContent = '☀️';
                    textSpan.textContent = 'ライトモード';
                } else {
                    iconSpan.textContent = '🌙';
                    textSpan.textContent = 'ダークモード';
                }
            }
        }

        function setupThemeToggle() {
            const htmlElement = document.documentElement;
            
            // 保存されたテーマを読み込み、なければダークモードをデフォルトに
            const savedTheme = localStorage.getItem('theme') || 'dark';
            htmlElement.setAttribute('data-theme', savedTheme);
            
            // ページ読み込み時にアイコンを更新
            updateThemeIcon();
        }
    </script>
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .recommendation-section .text-center {
            text-align: center;
        }
        
        /* モバイル対応 */
        @media (max-width: 768px) {
            .recommendation-section {
                padding: 40px 0 !important;
            }
            
            .recommendation-section h2 {
                font-size: 1.8rem !important;
            }
            
            .recommendation-section .recommendation-settings {
                padding: 20px !important;
            }
            
            .recommendation-section label {
                flex-direction: column !important;
                text-align: center !important;
                padding: 15px !important;
            }
            
            .recommendation-section label small {
                margin-left: 0 !important;
                margin-top: 5px !important;
            }
            
            #getRecommendationBtn {
                padding: 12px 25px !important;
                font-size: 1rem !important;
            }
        }
    </style>
</body>
</html> 